## Project Structure

```
autoart_v02/
├── backend/           # Fastify API server
│   └── src/
│       ├── db/        # Kysely migrations, schema, seeds
│       ├── modules/   # Feature modules (auth, imports, hierarchy, etc.)
│       └── app.ts     # Entry point
├── frontend/          # React + Vite application
│   └── src/
│       ├── pages/     # Route-level components
│       ├── surfaces/  # Domain-specific views/sidebars/inspectors
│       ├── ui/        # Design system (atoms, molecules, composites)
│       └── lib/       # API hooks (TanStack Query)
├── shared/            # Shared types, schemas, utilities
│   └── src/
│       ├── schemas/   # Zod validation schemas
│       ├── types/     # TypeScript types
│       └── utils/     # Shared utilities
├── docs/              # Documentation and implementation plans
├── scripts/           # Build and utility scripts
├── .CLAUDE.md         # This file (AI coding assistant guide)
└── README.md          # Project overview
```

## Coding Principles

Enforce schema
Enforce semantics
Add new UI elements to component library
use shared for registering
Zod exists
Reuse existing elements whenever possible.
Code within bounding canonical datatypes and use cases
Do not code new styles or components or modules inline

## USER BEHAVIOR
User updates a todo in the root with an entry number
After you finish a task, respond to the entry number
use a two to three sentence slug to describe how you acomplished the task
reorder the tasks in the todo list per entry and carry forward any defferred tasks into the start of the next entry
use this document to "converse" with the user between instances without breaking format
when you revisit a completed task, do not repeat work
request to prune completed tasks from the task list when the context they provide is no longer relevant


## Package Manager: pnpm

This project uses **pnpm** for package management in a monorepo workspace structure.



### Workspace Structure
```
autoart/
├── pnpm-workspace.yaml    # Defines workspace packages + catalog
├── shared/                # @autoart/shared
├── backend/               # autoart-backend
├── frontend/              # autoart-frontend (two build targets)
│   ├── src/               # Dashboard + FormsDashboard + FormsEditor
│   ├── intake/            # Intake build entrypoint (index.html, main.tsx)
│   ├── src/intake/        # Intake app source (public forms)
│   ├── vite.config.ts     # Dashboard build → dist/
│   └── vite.intake.config.ts  # Intake build → dist-intake/
├── packages/ui/           # @autoart/ui
└── apps/
    └── mail/              # @autoart/mail-client
```

### Two Build Targets, One Engine

The frontend produces **two separate builds** from **one dependency set**:

| Build | Command | Output | Deploy Target |
|-------|---------|--------|---------------|
| Dashboard | `pnpm build:frontend` | `frontend/dist/` | app.autoart.work |
| Intake | `pnpm build:intake` | `dist-intake/` | intake.autoart.work |

**Why this matters:**
- Single `frontend/package.json` = no version drift between apps
- Intake is a build artifact, not a separate product
- Both share `@autoart/shared`, `@autoart/ui`, same React/Tailwind versions

**Intake runtime requirements:**
- Must be able to render without backend (or use always-on public endpoints)
- Proxies `/public` to backend during dev only
- Deploy as static SPA with fallback rewrite (`/* → /index.html`)

### pnpm Cheatsheet

#### Installation & Setup
```powershell
# Install pnpm globally (if not using corepack)
npm install -g pnpm

# Install all workspace dependencies
pnpm install

# Install a dependency in a specific package
pnpm --filter autoart-backend add lodash
pnpm --filter @autoart/forms add -D vitest
```

#### Running Scripts
```powershell
# Run script in specific package
pnpm --filter autoart-backend dev
pnpm --filter @autoart/shared build

# Run script in all packages that have it
pnpm -r build
pnpm -r typecheck

# Run from root (uses scripts in root package.json)
pnpm dev          # Starts all dev servers
pnpm dev:kill     # Kills all dev processes
pnpm migrate      # Run database migrations
pnpm db:rebuild   # Nuke + migrate + seed
```

#### Workspace Dependencies
```json
// Use workspace:* for local package dependencies
{
  "dependencies": {
    "@autoart/shared": "workspace:*",
    "@autoart/ui": "workspace:*"
  }
}
```

#### Catalog Dependencies (centralized versions)
```json
// Use catalog: to pull version from pnpm-workspace.yaml
{
  "devDependencies": {
    "typescript": "catalog:",
    "eslint": "catalog:",
    "vitest": "catalog:"
  }
}
```
See `.agent/rules/pnpm-catalog.md` for the full catalog and update procedure.

#### Common Commands
| Command | Description |
|---------|-------------|
| `pnpm install` | Install all dependencies |
| `pnpm add <pkg>` | Add dependency to current package |
| `pnpm add -D <pkg>` | Add dev dependency |
| `pnpm remove <pkg>` | Remove dependency |
| `pnpm --filter <name> <cmd>` | Run command in specific package |
| `pnpm -r <cmd>` | Run command recursively in all packages |
| `pnpm build:shared` | Build the shared package (run first!) |
| `pnpm why <pkg>` | Show why a package is installed |

#### Filter Syntax
```powershell
# By package name
pnpm --filter autoart-backend dev
pnpm --filter @autoart/shared build

# By directory
pnpm --filter ./backend dev
pnpm --filter "./apps/*" build

# Dependencies of a package
pnpm --filter "...@autoart/forms" build  # Build forms and its deps
```

#### Troubleshooting
```powershell
# Clear pnpm cache and reinstall
pnpm store prune
Remove-Item -Recurse -Force node_modules
pnpm install

# Check what would be installed
pnpm install --dry-run

# Force rebuild of a package
pnpm --filter @autoart/shared build --force
```

---

## Shell Environment & Git Commands

### PowerShell Basics
- This project runs on **Windows PowerShell**
- Do NOT use `&&` to chain commands (use `;` instead)
- Commands are executed via the `run_command` tool

### Git Command Patterns

#### Simple Git Operations
```powershell
# Stage and commit - use semicolon to chain
git add -A; git commit -m 'feat: your message here'

# Push to remote
git push

# Pull latest
git pull
```

#### CRITICAL: Escaping Rules for Git Commit Messages
1. **Use single quotes** around commit messages to avoid PowerShell escaping issues
2. **Keep messages on ONE LINE** - no newlines
3. **Do NOT use double quotes** inside single quotes
4. **Avoid special characters** like `[`, `]`, `(`, `)` in commit messages if possible
5. **If you need special chars**, escape them or use a commit message file

```powershell
# ✅ CORRECT - Simple message with single quotes
git commit -m 'feat: add new feature'

# ✅ CORRECT - Message with colon and spaces
git commit -m 'fix: resolve issue with data loading'

# ❌ WRONG - Double quotes can cause issues
git commit -m "feat: add feature"

# ❌ WRONG - Special characters without escaping
git commit -m 'feat: Owner -> Assignee (Issue #14)'

# ✅ CORRECT - Use simpler wording
git commit -m 'feat: rename Owner to Assignee for issue 14'
```

#### Creating Commit Message Files (for complex messages)
If you need multi-line commits or special characters:
```powershell
# Create commit message file
@'
feat: nomenclature alignment

- Change Owner to Assignee
- Update README prerequisites
- Closes #14
'@ | Out-File -FilePath commit.txt -Encoding utf8

# Commit using file
git commit -F commit.txt

# Clean up
Remove-Item commit.txt
```

## Issue Management with gh CLI

### CRITICAL Tool Calling Rules
- `gh` commands are **TERMINAL COMMANDS** executed via `run_command` tool
- **NEVER** use `gh` commands with `browser_subagent` or any browser tools
- The error `'[data-tooltip-id="gh pr create..."]' is not a valid selector` means you tried to use a shell command as a browser selector

### Correct gh CLI Usage

#### View Issues
```powershell
# View issue details
gh issue view 14

# View with JSON output
gh issue view 14 --json title,body,labels

# List all open issues
gh issue list
```

#### Create Pull Requests
**Option 1: Simple PR (recommended)**
```powershell
# Create PR interactively
gh pr create

# Create with basic flags
gh pr create --base main --title 'feat: short description'
```

**Option 2: Full specification (use temp file for body)**
```powershell
# Step 1: Create PR body file
@'
Closes #14

## Changes
- Update README prerequisites
- Change Owner label to Assignee
- Add documentation

## Testing
- Verified builds pass
- No breaking changes
'@ | Out-File -FilePath pr-body.txt -Encoding utf8

# Step 2: Create PR using file
gh pr create --title 'feat: nomenclature alignment' --body-file pr-body.txt --base main

# Step 3: Clean up
Remove-Item pr-body.txt
```

**Option 3: One-line body (limited use)**
```powershell
# Only for very short descriptions
gh pr create --title 'feat: update docs' --body 'Minor documentation updates' --base main
```

### PR Creation Best Practices
- ✅ Use `--body-file` for any non-trivial PR descriptions
- ✅ Keep `--title` short (50 chars or less)
- ✅ Follow conventional commits: `feat:`, `fix:`, `docs:`, `refactor:`, etc.
- ✅ Reference issues with `Closes #N` in body
- ❌ Avoid inline `--body` with special characters
- ❌ Don't put complex markdown in command line arguments

### Troubleshooting Common Errors

#### Error: "is not a valid selector"
```
Failed to execute 'querySelector' on 'Document': '[data-tooltip-id="gh pr create..."]' is not a valid selector
```

**Cause**: You tried to use a terminal command (like `gh pr create`) with a browser tool instead of `run_command`.

**Solution**:
1. ✅ Use `run_command` tool for ALL `git` and `gh` commands
2. ✅ Use `browser_subagent` ONLY for web page interactions
3. ❌ NEVER pass shell commands to browser tools

**Example of correct usage**:
```typescript
// ✅ CORRECT - Using run_command for git/gh
run_command({
  CommandLine: "gh pr create --title 'feat: add feature' --body-file pr-body.txt",
  Cwd: "e:\\autoart_v02",
  SafeToAutoRun: false,
  WaitMsBeforeAsync: 3000
})

// ❌ WRONG - Using browser tool for shell commands
browser_subagent({
  Task: "gh pr create --title 'feat: add feature'",  // This will fail!
  ...
})
```

#### Error: Git commit fails with escaping issues
**Cause**: Special characters in commit message not properly escaped for PowerShell

**Solution**: Use the commit message file approach shown above in "Creating Commit Message Files"

## Nomenclature Standards

### Canonical Terminology
| ❌ Do NOT Use | ✅ Use Instead | Context |
|---------------|----------------|---------|
| Owner | Assignee | User assigned to a task/action |
| Completed | Done | Task/action status |
| History | Log | Event display panel |
| GLOBAL | CONTEXT | Event bucket scoping |

### Action/Event Architecture
- All mutations go through **Actions** (user intent)
- Actions produce **Events** (observable outcomes)
- Events are scoped by `context_type` + `context_id`
- No direct "field update" events - use Actions instead
- Composer orchestrates Action → Event flow

### Soft-Intrinsic Type Derivation (CRITICAL)
Action types like Task, Subtask, etc. must be **derived from context and parent relationships**, NOT explicitly checked via conditionals:

```typescript
// ❌ WRONG - Explicit type checks violate soft-intrinsic architecture
if (item.entityType === 'subtask') {
    actionType = 'Subtask';
} else {
    actionType = 'Task';
}

// ✅ CORRECT - Derive from parent relationship
const parentIsItem = item.parentTempId && itemsByTempId.has(item.parentTempId);
// parentActionId signals child relationship
// Projection system derives actual type from context + parent_action_id
```

**Red flags** that indicate architecture violation:
- Variables named `task`, `subtask`, `actionType` with explicit string values
- Conditionals on `entityType === 'subtask'` or `entityType === 'task'`
- Hardcoded type values like `type: 'Subtask'`

**Correct approach**:
- Set `parent_action_id` based on whether parent is another action
- Set `context_id` and `context_type` properly
- Use base type `'Task'` - projection derives actual type from relationships

### Variable Naming
```typescript
// ❌ Wrong
const owner = user;
const history = events;

// ✅ Correct
const assignee = user;
const log = events;
```


Database Conventions
Naming
Tables: snake_case plural (e.g., hierarchy_nodes, task_references)
Columns: snake_case (e.g., parent_id, source_record_id)
Types/Enums: snake_case (e.g., node_type, ref_mode)
UUIDs
All primary keys use gen_random_uuid()
Enables collision-free cloning and distributed systems
JSONB Patterns
schema_config.fields[]: Array of field definitions
data: Key-value pairs matching schema field keys
metadata: Flexible node-specific configuration
API Conventions
Backend (Fastify)
Request/Response: camelCase (e.g., schemaConfig, definitionId)
Zod schemas for validation
Standard response wrappers: { node }, { records }, { reference }
Frontend (React + TanStack Query)
Types use database column names (snake_case) for data types
API input types use camelCase to match backend expectations
Mutations invalidate relevant query keys
Migration Requirements
CRITICAL: Always Keep Migrations Updated
When adding new features that require database changes:

Check if migration exists for the table/column
Create new migration if schema change is needed
Add seed data for required default records (e.g., node type definitions)
Run migrations to verify: npm run migrate
Update schema.ts if types change

## Frontend Architecture Patterns

### Page vs View vs Surface

- **Page** (`/pages/*.tsx`): Route-level shell. Minimal logic. Composes:
  - `Header` component
  - Left sidebar/panel (via resizable aside)
  - Center View component
  - Right Inspector (via `SelectionInspector` or domain-specific)
  - `BottomDrawer` for modals/dialogs
  - `ResizeHandle` between panels

- **View** (`/surfaces/{domain}/*View.tsx`): The main workspace content. Receives state via props from Page. Contains preview tabs, tables, or visualization.

- **Sidebar** (`/surfaces/{domain}/*Sidebar.tsx`): Left panel for configuration, navigation, or source selection. Receives state via props from Page.

- **Inspector** (`/surfaces/{domain}/*Inspector.tsx`): Right panel for detailed inspection of selected items.

### State Flow

Pages own state and pass down via props:
```tsx
// Page pattern
const [session, setSession] = useState<Session | null>(null);
const [selectedId, setSelectedId] = useState<string | null>(null);

<Sidebar session={session} onSessionCreated={setSession} />
<View session={session} selectedId={selectedId} onSelect={setSelectedId} />
<Inspector selectedId={selectedId} />
```

For complex global state, use Zustand stores (e.g., `useUIStore`, `useImportWorkbenchStore`).

### Drawer Pattern

Use `openDrawer(type, context)` from `useUIStore` for modal-like interactions:
- `'classification'` - classification review (in BottomDrawer)
- `'integrations'` - API connections setup
- `'create-node'`, `'create-record'` - creation forms

**NOTE**: Board selection is NOT a drawer - it's inline in the sidebar. Click board → preview in center.

### Naming Conventions

| File | Purpose |
|------|---------|
| `{Domain}Page.tsx` | Route shell in `/pages/` |
| `{Domain}View.tsx` | Center content in `/surfaces/{domain}/` |
| `{Domain}Sidebar.tsx` | Left panel in `/surfaces/{domain}/` |
| `{Domain}Inspector.tsx` | Right panel in `/surfaces/{domain}/` |
| `{Domain}Content.tsx` | Alternative center content (if multiple views exist) |

### Reference Files

- `ProjectPage.tsx` - canonical page pattern
- `ProjectWorkflowView.tsx` - complex view with sidebar integration
- `ImportPage.tsx` - import workbench pattern

### UI Components

**Do NOT use Mantine.** All UI must use bespoke atoms/molecules from `ui/atoms/` and `ui/molecules/`.

#### Atoms (`ui/atoms/`)
| Component | Key Props |
|-----------|-----------|
| `Button` | `variant`: `primary`, `secondary`, `ghost`, `danger`, `light`, `subtle` / `size`: `xs`, `sm`, `md`, `lg` / `color`: `gray`, `blue`, `violet`, `yellow` / `leftSection`, `rightSection` |
| `IconButton` | `icon`, `variant`: `ghost`, `subtle`, `solid` / `size`, `label`, `active` |
| `Badge` | `variant`: `project`, `process`, `stage`, `subprocess`, `task`, `default`, `warning`, `light`, `success`, `error`, `neutral`, `info` / `size`: `xs`, `sm`, `md` |
| `Text` | `size`: `xs`, `sm`, `md`, `lg` / `color`: `default`, `muted`, `error` / `weight`: `normal`, `medium`, `semibold`, `bold` / `truncate` |
| `TextInput` | `label`, `placeholder`, `error`, `description` |
| `Select` | `label`, `options`, `placeholder` |
| `Checkbox` | `label`, `description`, `indeterminate`, `onChange: (checked: boolean) => void` |
| `RadioGroup` | `options`, `value`, `onChange` |
| `Card` | Basic container with border/shadow |
| `Stack` | `gap`: `xs`, `sm`, `md`, `lg` |
| `Inline` | `gap`, `align`, `justify`, `wrap` |
| `Spinner` | Loading indicator |
| `Alert` | `variant`: `info`, `warning`, `error`, `success` |
| `ProgressBar` | Progress visualization |

#### Molecules (`ui/molecules/`)
| Component | Description |
|-----------|-------------|
| `Menu` | Dropdown menu with `Menu.Target`, `Menu.Dropdown`, `Menu.Item`, `Menu.Label`, `Menu.Divider` |
| `SegmentedControl` | Button group toggle with `data`, `value`, `onChange` |

#### Table Components (`ui/table/`)
| Component | Description |
|-----------|-------------|
| `TableFrame` | Scroll container with border/shadow |
| `TableHeaderRow` / `TableRow` | Row primitives with `size`, `selected`, `hoverable` |
| `TableHeaderCell` / `TableCell` | Cell primitives with `width`, `align`, `sortable` |

#### Migration from Mantine
| Mantine | Bespoke Replacement |
|---------|---------------------|
| `Button variant="default"` | `Button variant="secondary"` |
| `Button variant="light"` | `Button variant="light"` |
| `Button variant="subtle"` | `Button variant="subtle"` or `variant="ghost"` |
| `Group` | `Inline` |
| `Stack` | `Stack` |
| `Text c="dimmed"` | `Text color="muted"` |
| `Text fw={500}` | `Text weight="medium"` |
| `Loader` | `Spinner` |
| `Paper` | `<div className="bg-white border border-slate-200 rounded-lg p-4">` |
| `Box` | Plain `<div>` with Tailwind classes |
| `ActionIcon` | `IconButton` |
| `ThemeIcon` | Styled `<div>` with icon inside |

---

## Import Workbench Architecture

### Layout Zones

```
┌─────────────────────────────────────────────────────────┐
│ Header                                                  │
├──────────┬────────────────────────────────┬────────────┤
│ Sidebar  │     Center View (SWAPPABLE)    │ Inspector  │
│ (source  │                                │ (item      │
│  icons + │  - FilePreviewView             │  details)  │
│  config) │  - MondayPreviewView           │            │
│          │  - etc.                        │            │
├──────────┴────────────────────────────────┴────────────┤
│ BottomDrawer (ClassificationPanel @ 80% height)        │
└─────────────────────────────────────────────────────────┘
```

### Responsibility Split

| Zone | Contains | Does NOT contain |
|------|----------|------------------|
| **Sidebar** | Source icons, board list (names only), parser config, file upload/paste | Data preview, full board content |
| **Center View** | Data preview, tables, hierarchy, empty states | Source selection, board lists |
| **BottomDrawer** | ClassificationPanel only (opens automatically when unresolved items exist) | Board selectors, other content |

**Sidebar-to-Center Flow**: Click item in sidebar → action triggers → result shows in center view

### Center View Swapping

ImportPage is a wrapper** that swaps center views based on source type:

```tsx
// ImportPage pattern
<ImportSidebar sourceType={sourceType} onSourceChange={setSourceType} />

{/* Center view swaps based on source */}
{sourceType === 'file' && <ImportWorkbenchView ... />}
{sourceType === 'monday' && <MondayPreviewView ... />}
{sourceType === 'api' && <ApiPreviewView ... />}
```

### What Goes Where

| Content | Location |
|---------|----------|
| Board name list | **Sidebar inline** (click to import) |
| Board data preview | Center MondayPreviewView |
| Classification review | BottomDrawer @ 80% (auto-opens) |
| Item field details | Right Inspector |
| Parser selection | Sidebar inline |
| File upload/paste | Sidebar inline |
