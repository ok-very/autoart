Enforce schema
Enforce semantics
Add new UI elements to component library
use shared for registering
Zod exists
Reuse existing elements whenever possible.
Code withing bounding canonical datatypes and use cases
Do not code new styles or components or modules inline

Database Conventions
Naming
Tables: snake_case plural (e.g., hierarchy_nodes, task_references)
Columns: snake_case (e.g., parent_id, source_record_id)
Types/Enums: snake_case (e.g., node_type, ref_mode)
UUIDs
All primary keys use gen_random_uuid()
Enables collision-free cloning and distributed systems
JSONB Patterns
schema_config.fields[]: Array of field definitions
data: Key-value pairs matching schema field keys
metadata: Flexible node-specific configuration
API Conventions
Backend (Fastify)
Request/Response: camelCase (e.g., schemaConfig, definitionId)
Zod schemas for validation
Standard response wrappers: { node }, { records }, { reference }
Frontend (React + TanStack Query)
Types use database column names (snake_case) for data types
API input types use camelCase to match backend expectations
Mutations invalidate relevant query keys
Migration Requirements
CRITICAL: Always Keep Migrations Updated
When adding new features that require database changes:

Check if migration exists for the table/column
Create new migration if schema change is needed
Add seed data for required default records (e.g., node type definitions)
Run migrations to verify: npm run migrate
Update schema.ts if types change

## Frontend Architecture Patterns

### Page vs View vs Surface

- **Page** (`/pages/*.tsx`): Route-level shell. Minimal logic. Composes:
  - `Header` component
  - Left sidebar/panel (via resizable aside)
  - Center View component
  - Right Inspector (via `SelectionInspector` or domain-specific)
  - `BottomDrawer` for modals/dialogs
  - `ResizeHandle` between panels

- **View** (`/surfaces/{domain}/*View.tsx`): The main workspace content. Receives state via props from Page. Contains preview tabs, tables, or visualization.

- **Sidebar** (`/surfaces/{domain}/*Sidebar.tsx`): Left panel for configuration, navigation, or source selection. Receives state via props from Page.

- **Inspector** (`/surfaces/{domain}/*Inspector.tsx`): Right panel for detailed inspection of selected items.

### State Flow

Pages own state and pass down via props:
```tsx
// Page pattern
const [session, setSession] = useState<Session | null>(null);
const [selectedId, setSelectedId] = useState<string | null>(null);

<Sidebar session={session} onSessionCreated={setSession} />
<View session={session} selectedId={selectedId} onSelect={setSelectedId} />
<Inspector selectedId={selectedId} />
```

For complex global state, use Zustand stores (e.g., `useUIStore`, `useImportWorkbenchStore`).

### Drawer Pattern

Use `openDrawer(type, context)` from `useUIStore` for modal-like interactions:
- `'classification'` - classification review (in BottomDrawer)
- `'integrations'` - API connections setup
- `'create-node'`, `'create-record'` - creation forms

**NOTE**: Board selection is NOT a drawer - it's inline in the sidebar. Click board → preview in center.

### Naming Conventions

| File | Purpose |
|------|---------|
| `{Domain}Page.tsx` | Route shell in `/pages/` |
| `{Domain}View.tsx` | Center content in `/surfaces/{domain}/` |
| `{Domain}Sidebar.tsx` | Left panel in `/surfaces/{domain}/` |
| `{Domain}Inspector.tsx` | Right panel in `/surfaces/{domain}/` |
| `{Domain}Content.tsx` | Alternative center content (if multiple views exist) |

### Reference Files

- `ProjectPage.tsx` - canonical page pattern
- `ProjectWorkflowView.tsx` - complex view with sidebar integration
- `ImportPage.tsx` - import workbench pattern

### UI Atoms

Use bespoke components from `ui/atoms`:
- `Badge`, `Button`, `Card`, `Checkbox`, `Inline`, `Stack`, `Text`, `TextInput`, `Select`, `Spinner`, `RadioGroup`, `Alert`

Do NOT use Mantine components. All UI must use bespoke atoms or custom implementations.

---

## Import Workbench Architecture

### Layout Zones

```
┌─────────────────────────────────────────────────────────┐
│ Header                                                  │
├──────────┬────────────────────────────────┬────────────┤
│ Sidebar  │     Center View (SWAPPABLE)    │ Inspector  │
│ (source  │                                │ (item      │
│  icons + │  - FilePreviewView             │  details)  │
│  config) │  - MondayPreviewView           │            │
│          │  - etc.                        │            │
├──────────┴────────────────────────────────┴────────────┤
│ BottomDrawer (ClassificationPanel @ 80% height)        │
└─────────────────────────────────────────────────────────┘
```

### Responsibility Split

| Zone | Contains | Does NOT contain |
|------|----------|------------------|
| **Sidebar** | Source icons, board list (names only), parser config, file upload/paste | Data preview, full board content |
| **Center View** | Data preview, tables, hierarchy, empty states | Source selection, board lists |
| **BottomDrawer** | ClassificationPanel only (opens automatically when unresolved items exist) | Board selectors, other content |

**Sidebar-to-Center Flow**: Click item in sidebar → action triggers → result shows in center view

### Center View Swapping

ImportPage is a **wrapper** that swaps center views based on source type:

```tsx
// ImportPage pattern
<ImportSidebar sourceType={sourceType} onSourceChange={setSourceType} />

{/* Center view swaps based on source */}
{sourceType === 'file' && <ImportWorkbenchView ... />}
{sourceType === 'monday' && <MondayPreviewView ... />}
{sourceType === 'api' && <ApiPreviewView ... />}
```

### What Goes Where

| Content | Location |
|---------|----------|
| Board name list | **Sidebar inline** (click to import) |
| Board data preview | Center MondayPreviewView |
| Classification review | BottomDrawer @ 80% (auto-opens) |
| Item field details | Right Inspector |
| Parser selection | Sidebar inline |
| File upload/paste | Sidebar inline |

### Monday Board Import Flow

1. User clicks Monday icon in sidebar → `sourceType` changes to `'monday'`
2. Sidebar shows searchable board list (just names + item counts)
3. User clicks a board → `handleBoardSelect(boardId)` imports it
4. Center view updates from empty state to `MondayPreviewView` with data
5. If unresolved classifications exist → BottomDrawer auto-opens with ClassificationPanel

