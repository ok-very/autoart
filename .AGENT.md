# AutoArt Agent Guide

## Project Structure

```
autoart/
├── backend/        # Fastify API (modules/, db/)
├── frontend/       # React + Vite (pages/, surfaces/, ui/)
├── shared/         # @autoart/shared (schemas/, types/)
├── packages/ui/    # @autoart/ui
└── apps/mail/      # @autoart/mail-client
```

## Skills Reference

| File | Covers |
|------|--------|
| `.claude/skills/git.md` | Stacked PRs, merging, commits, branch hygiene |
| `.claude/skills/frontend.md` | Component patterns, UI atoms, Zustand |
| `.claude/skills/backend.md` | Architecture, soft-intrinsic types, database |
| `.claude/skills/project.md` | Commands, nomenclature, pnpm catalog |

## Coding Principles

- Enforce schema (Zod in `shared/`)
- Reuse existing UI atoms/molecules - **no Mantine**
- No inline styles/components - add to component library
- Derive types from relationships, not explicit checks

## Plan Execution

**Multi-phase plans require stacked PRs.**

```bash
git commit -m "phase N: description"
pnpm git:stack  # Creates PR targeting current branch
```

Link PRs to issues: `Closes #N` or `Refs #N`

## User Behavior Protocol

- User updates todo with entry number
- Respond with 2-3 sentence summary of how task was accomplished
- Reorder tasks, carry forward deferred items
- Don't repeat completed work
- Request pruning when old tasks lose context relevance

## Common Commands

```bash
pnpm dev              # Start all services
pnpm build            # Build shared + backend
pnpm migrate          # Run DB migrations
pnpm db:rebuild       # Nuke + migrate + seed
pnpm --filter <pkg>   # Run in specific package
```

## Critical Architecture Rules

### Soft-Intrinsic Type Derivation

Action types are **derived from relationships**, not explicit checks:

```typescript
// WRONG
if (item.entityType === 'subtask') { actionType = 'Subtask'; }

// CORRECT - derive from parent relationship
const hasParent = item.parentTempId && itemsByTempId.has(item.parentTempId);
// Projection system derives type from context + parent_action_id
```

### Frontend Patterns

| Pattern | Location | Purpose |
|---------|----------|---------|
| `{Domain}Page.tsx` | `/pages/` | Route shell, owns state |
| `{Domain}View.tsx` | `/surfaces/{domain}/` | Center content |
| `{Domain}Sidebar.tsx` | `/surfaces/{domain}/` | Left panel |
| `{Domain}Inspector.tsx` | `/surfaces/{domain}/` | Right panel |

Pages own state, pass down via props. Complex global state → Zustand stores.

### Nomenclature

| Don't Use | Use |
|-----------|-----|
| Owner | Assignee |
| Completed | Done |
| History | Log |
| action_recipe | action_arrangement |

## Build Targets

| Build | Command | Output |
|-------|---------|--------|
| Dashboard | `pnpm build:frontend` | `frontend/dist/` |
| Intake | `pnpm build:intake` | `dist-intake/` |

Both share same dependencies - Intake is a build artifact, not separate product.
