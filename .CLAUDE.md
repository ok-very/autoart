Enforce schema
Enforce semantics
Add new UI elements to component library
use shared for registering
Zod exists
Reuse existing elements whenever possible.
Code within bounding canonical datatypes and use cases
Do not code new styles or components or modules inline

## Shell Environment
- This project runs on **Windows PowerShell**
- Do NOT use `&&` to chain commands (use `;` instead)
- Example: `git add -A; git commit -m "message"; git push`
- Use **single quotes** for commit messages to avoid escaping issues
- Keep commit messages on **one line** only

## Issue Management
- **Use `gh` CLI for issues and PRs** - these are TERMINAL COMMANDS, not browser selectors
- **CRITICAL**: `gh` commands must be run via `run_command` tool, NEVER as browser tool selectors

### Common gh CLI Commands
```bash
# View issue details
gh issue view <number> --json title,body,labels

# List open issues
gh issue list

# Create PR (use single quotes around message values on Windows)
gh pr create --title 'feat: short description' --body 'Longer body text here' --base main
```

### PR Creation Best Practices
- Keep title short and descriptive (conventional commits style)
- Body can reference issues with `Closes #14` syntax
- Use single quotes on Windows to avoid escaping issues
- Multi-line body: Use a file instead or keep on one line

## Nomenclature Standards

### Canonical Terminology
| ❌ Do NOT Use | ✅ Use Instead | Context |
|---------------|----------------|---------|
| Owner | Assignee | User assigned to a task/action |
| Completed | Done | Task/action status |
| History | Log | Event display panel |
| GLOBAL | CONTEXT | Event bucket scoping |

### Action/Event Architecture
- All mutations go through **Actions** (user intent)
- Actions produce **Events** (observable outcomes)
- Events are scoped by `context_type` + `context_id`
- No direct "field update" events - use Actions instead
- Composer orchestrates Action → Event flow

### Variable Naming
```typescript
// ❌ Wrong
const owner = user;
const history = events;

// ✅ Correct
const assignee = user;
const log = events;
```


## Recent Work Context (Phase 1-2 Complete)

### Issue #4: Shared Package Reorganization ✓
- Created barrel exports: `schemas/index.ts`, `types/index.ts`
- Reduced main `index.ts` from 340 → 70 lines
- No circular dependencies confirmed
- Added `ARCHITECTURE.md` for shared package

### Issue #5: Backend Module Cleanup ✓
- Created barrel exports for 6 modules (auth, hierarchy, interpreter, links, references, search)
- Fixed cross-module import via `utils/auth.ts` shared utility
- Fixed deep import using path alias (`@db/client.js`)
- Added `ExportSessionsTable` to database schema
- Unified token expiry behavior (`getGoogleToken` now matches `getMondayToken` - warns and falls back instead of throwing)
- Created `backend/ARCHITECTURE.md`
- All modules now have `index.ts` barrel exports
- Backend build passes ✓

### Open Issues (From API)
- #20: Error handling standardization (high priority)
- #19: Testing baseline (v1 blocker)
- #18: Milestone - Merge to main
- #17: InDesign CSV export (low priority, long-term)
- #16: PDF export with Carlito (low priority)

Database Conventions
Naming
Tables: snake_case plural (e.g., hierarchy_nodes, task_references)
Columns: snake_case (e.g., parent_id, source_record_id)
Types/Enums: snake_case (e.g., node_type, ref_mode)
UUIDs
All primary keys use gen_random_uuid()
Enables collision-free cloning and distributed systems
JSONB Patterns
schema_config.fields[]: Array of field definitions
data: Key-value pairs matching schema field keys
metadata: Flexible node-specific configuration
API Conventions
Backend (Fastify)
Request/Response: camelCase (e.g., schemaConfig, definitionId)
Zod schemas for validation
Standard response wrappers: { node }, { records }, { reference }
Frontend (React + TanStack Query)
Types use database column names (snake_case) for data types
API input types use camelCase to match backend expectations
Mutations invalidate relevant query keys
Migration Requirements
CRITICAL: Always Keep Migrations Updated
When adding new features that require database changes:

Check if migration exists for the table/column
Create new migration if schema change is needed
Add seed data for required default records (e.g., node type definitions)
Run migrations to verify: npm run migrate
Update schema.ts if types change

## Frontend Architecture Patterns

### Page vs View vs Surface

- **Page** (`/pages/*.tsx`): Route-level shell. Minimal logic. Composes:
  - `Header` component
  - Left sidebar/panel (via resizable aside)
  - Center View component
  - Right Inspector (via `SelectionInspector` or domain-specific)
  - `BottomDrawer` for modals/dialogs
  - `ResizeHandle` between panels

- **View** (`/surfaces/{domain}/*View.tsx`): The main workspace content. Receives state via props from Page. Contains preview tabs, tables, or visualization.

- **Sidebar** (`/surfaces/{domain}/*Sidebar.tsx`): Left panel for configuration, navigation, or source selection. Receives state via props from Page.

- **Inspector** (`/surfaces/{domain}/*Inspector.tsx`): Right panel for detailed inspection of selected items.

### State Flow

Pages own state and pass down via props:
```tsx
// Page pattern
const [session, setSession] = useState<Session | null>(null);
const [selectedId, setSelectedId] = useState<string | null>(null);

<Sidebar session={session} onSessionCreated={setSession} />
<View session={session} selectedId={selectedId} onSelect={setSelectedId} />
<Inspector selectedId={selectedId} />
```

For complex global state, use Zustand stores (e.g., `useUIStore`, `useImportWorkbenchStore`).

### Drawer Pattern

Use `openDrawer(type, context)` from `useUIStore` for modal-like interactions:
- `'classification'` - classification review (in BottomDrawer)
- `'integrations'` - API connections setup
- `'create-node'`, `'create-record'` - creation forms

**NOTE**: Board selection is NOT a drawer - it's inline in the sidebar. Click board → preview in center.

### Naming Conventions

| File | Purpose |
|------|---------|
| `{Domain}Page.tsx` | Route shell in `/pages/` |
| `{Domain}View.tsx` | Center content in `/surfaces/{domain}/` |
| `{Domain}Sidebar.tsx` | Left panel in `/surfaces/{domain}/` |
| `{Domain}Inspector.tsx` | Right panel in `/surfaces/{domain}/` |
| `{Domain}Content.tsx` | Alternative center content (if multiple views exist) |

### Reference Files

- `ProjectPage.tsx` - canonical page pattern
- `ProjectWorkflowView.tsx` - complex view with sidebar integration
- `ImportPage.tsx` - import workbench pattern

### UI Components

**Do NOT use Mantine.** All UI must use bespoke atoms/molecules from `ui/atoms/` and `ui/molecules/`.

#### Atoms (`ui/atoms/`)
| Component | Key Props |
|-----------|-----------|
| `Button` | `variant`: `primary`, `secondary`, `ghost`, `danger`, `light`, `subtle` / `size`: `xs`, `sm`, `md`, `lg` / `color`: `gray`, `blue`, `violet`, `yellow` / `leftSection`, `rightSection` |
| `IconButton` | `icon`, `variant`: `ghost`, `subtle`, `solid` / `size`, `label`, `active` |
| `Badge` | `variant`: `project`, `process`, `stage`, `subprocess`, `task`, `default`, `warning`, `light`, `success`, `error`, `neutral`, `info` / `size`: `xs`, `sm`, `md` |
| `Text` | `size`: `xs`, `sm`, `md`, `lg` / `color`: `default`, `muted`, `error` / `weight`: `normal`, `medium`, `semibold`, `bold` / `truncate` |
| `TextInput` | `label`, `placeholder`, `error`, `description` |
| `Select` | `label`, `options`, `placeholder` |
| `Checkbox` | `label`, `description`, `indeterminate`, `onChange: (checked: boolean) => void` |
| `RadioGroup` | `options`, `value`, `onChange` |
| `Card` | Basic container with border/shadow |
| `Stack` | `gap`: `xs`, `sm`, `md`, `lg` |
| `Inline` | `gap`, `align`, `justify`, `wrap` |
| `Spinner` | Loading indicator |
| `Alert` | `variant`: `info`, `warning`, `error`, `success` |
| `ProgressBar` | Progress visualization |

#### Molecules (`ui/molecules/`)
| Component | Description |
|-----------|-------------|
| `Menu` | Dropdown menu with `Menu.Target`, `Menu.Dropdown`, `Menu.Item`, `Menu.Label`, `Menu.Divider` |
| `SegmentedControl` | Button group toggle with `data`, `value`, `onChange` |

#### Table Components (`ui/table/`)
| Component | Description |
|-----------|-------------|
| `TableFrame` | Scroll container with border/shadow |
| `TableHeaderRow` / `TableRow` | Row primitives with `size`, `selected`, `hoverable` |
| `TableHeaderCell` / `TableCell` | Cell primitives with `width`, `align`, `sortable` |

#### Migration from Mantine
| Mantine | Bespoke Replacement |
|---------|---------------------|
| `Button variant="default"` | `Button variant="secondary"` |
| `Button variant="light"` | `Button variant="light"` |
| `Button variant="subtle"` | `Button variant="subtle"` or `variant="ghost"` |
| `Group` | `Inline` |
| `Stack` | `Stack` |
| `Text c="dimmed"` | `Text color="muted"` |
| `Text fw={500}` | `Text weight="medium"` |
| `Loader` | `Spinner` |
| `Paper` | `<div className="bg-white border border-slate-200 rounded-lg p-4">` |
| `Box` | Plain `<div>` with Tailwind classes |
| `ActionIcon` | `IconButton` |
| `ThemeIcon` | Styled `<div>` with icon inside |

---

## Import Workbench Architecture

### Layout Zones

```
┌─────────────────────────────────────────────────────────┐
│ Header                                                  │
├──────────┬────────────────────────────────┬────────────┤
│ Sidebar  │     Center View (SWAPPABLE)    │ Inspector  │
│ (source  │                                │ (item      │
│  icons + │  - FilePreviewView             │  details)  │
│  config) │  - MondayPreviewView           │            │
│          │  - etc.                        │            │
├──────────┴────────────────────────────────┴────────────┤
│ BottomDrawer (ClassificationPanel @ 80% height)        │
└─────────────────────────────────────────────────────────┘
```

### Responsibility Split

| Zone | Contains | Does NOT contain |
|------|----------|------------------|
| **Sidebar** | Source icons, board list (names only), parser config, file upload/paste | Data preview, full board content |
| **Center View** | Data preview, tables, hierarchy, empty states | Source selection, board lists |
| **BottomDrawer** | ClassificationPanel only (opens automatically when unresolved items exist) | Board selectors, other content |

**Sidebar-to-Center Flow**: Click item in sidebar → action triggers → result shows in center view

### Center View Swapping

ImportPage is a wrapper** that swaps center views based on source type:

```tsx
// ImportPage pattern
<ImportSidebar sourceType={sourceType} onSourceChange={setSourceType} />

{/* Center view swaps based on source */}
{sourceType === 'file' && <ImportWorkbenchView ... />}
{sourceType === 'monday' && <MondayPreviewView ... />}
{sourceType === 'api' && <ApiPreviewView ... />}
```

### What Goes Where

| Content | Location |
|---------|----------|
| Board name list | **Sidebar inline** (click to import) |
| Board data preview | Center MondayPreviewView |
| Classification review | BottomDrawer @ 80% (auto-opens) |
| Item field details | Right Inspector |
| Parser selection | Sidebar inline |
| File upload/paste | Sidebar inline |

### Monday Board Import Flow

1. User clicks Monday icon in sidebar → `sourceType` changes to `'monday'`
2. Sidebar shows searchable board list (just names + item counts)
3. User clicks a board → `handleBoardSelect(boardId)` imports it
4. Center view updates from empty state to `MondayPreviewView` with data
5. If unresolved classifications exist → BottomDrawer auto-opens with ClassificationPanel
